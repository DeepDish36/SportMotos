@model IEnumerable<dynamic> // Dynamic porque muda entre motos e peças

<div class="container mt-5">
    <div>
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a style="color:black; text-decoration:none" asp-controller="Home" asp-action="Index">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house-fill" viewBox="0 0 16 16">
                            <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z" />
                            <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z" />
                        </svg> SportMotos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    @(ViewBag.TipoAnuncio == "motos" ? "Motos" : "Peças")
                </li>
            </ol>
        </nav>
    </div>
    <h3 style="font-weight:bold" class="mb-4">
        Anúncios de <span style="font-weight:bold">
            @(ViewBag.TipoAnuncio == "motos" ? "Motos" : "Peças")
        </span>
    </h3>
    <h4 style="margin-bottom:2.5%">
        @(ViewBag.TipoAnuncio == "motos" ? "Encontre a moto dos seus sonhos!" : "Encontre as peças que precisa!")
    </h4>

    @if (ViewBag.TipoAnuncio == "motos")
    {
        <div class="row mb-4">
            <div class="col-md-9">
                <div class="row">
                    <div class="col">
                        <select id="marcaDropdown" class="form-select" onchange="filterAnuncios()">
                            <option value="">Marca</option>
                            @if (ViewBag.Marca != null)
                            {
                                foreach (var marca in ViewBag.Marca)
                                {
                                    <option value="@marca">@marca</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col">
                        <select id="modeloDropdown" class="form-select" disabled onchange="filterAnuncios()">
                            <option value="">Modelo</option>
                        </select>
                    </div>
                    <div class="col">
                        <select id="precoDropdown" class="form-select" onchange="filterAnuncios()">
                            <option value="">Preço</option>
                            <option value="0-5000">0 - 5000</option>
                            <option value="5000-10000">5000 - 10000</option>
                            <option value="10000-20000">10000 - 20000</option>
                            <option value="20000+">20000+</option>
                        </select>
                    </div>
                    <div class="col">
                        <select id="generoDropdown" class="form-select" onchange="filterAnuncios()">
                            <option value="">Género</option>
                            @if (ViewBag.Generos != null)
                            {
                                foreach (var genero in ViewBag.Generos)
                                {
                                    <option value="@genero">@genero</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col">
                        <select id="corDropdown" class="form-select" onchange="filterAnuncios()">
                            <option value="">Cor</option>
                            @if (ViewBag.Cores != null)
                            {
                                foreach (var cor in ViewBag.Cores)
                                {
                                    <option value="@cor">@cor</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

<div class="row row-cols-1 row-cols-md-4 g-4" id="anunciosContainer">
    @foreach (var anuncio in Model.OrderByDescending(a => a.DataPublicacao))
    {
        var diasPublicacao = (DateTime.Now - (anuncio.DataPublicacao ?? DateTime.Now)).TotalDays;

        <div class="col anuncio-card"
             data-marca="@(ViewBag.TipoAnuncio == "motos" ? anuncio.IdMotoNavigation?.Marca : anuncio.IdPecaNavigation?.Marca)"
             data-modelo="@(ViewBag.TipoAnuncio == "motos" ? anuncio.IdMotoNavigation?.Modelo : anuncio.IdPecaNavigation?.Modelo)"
             data-preco="@anuncio.Preco"
        @(ViewBag.TipoAnuncio == "motos" ? $"data-genero='{anuncio.IdMotoNavigation?.Genero}' data-cor='{anuncio.IdMotoNavigation?.Cor}'" : "")>

            <div class="card shadow-sm card-fixed-height position-relative">
                @if (ViewBag.TipoAnuncio == "motos" && anuncio.IdMotoNavigation != null && anuncio.IdMotoNavigation.Imagens != null && anuncio.IdMotoNavigation.Imagens.Any())
                {
                    <img src="@Url.Content("~/images/motos/" + anuncio.IdMotoNavigation.Imagens.FirstOrDefault()?.NomeArquivo)"
                         alt="Imagem da Moto @anuncio.IdMotoNavigation.Matricula"
                         class="img-fluid rounded card-img-top">
                }
                else if (ViewBag.TipoAnuncio == "pecas" && anuncio.IdPecaNavigation != null && !string.IsNullOrEmpty(anuncio.IdPecaNavigation.NomeArquivo))
                {
                    <img src="@Url.Content("~/images/pecas/" + anuncio.IdPecaNavigation.NomeArquivo)"
                         alt="Imagem da Peça"
                         class="img-fluid rounded card-img-top">
                }
                else
                {
                    <svg class="bd-placeholder-img card-img-top" width="100%" height="225" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false">
                        <title>@anuncio.Titulo</title>
                        <rect width="100%" height="100%" fill="#55595c"></rect>
                        <text x="50%" y="50%" fill="#eceeef" dy=".3em">Thumbnail</text>
                    </svg>
                }

                @if (ViewBag.TipoAnuncio == "motos" && anuncio.Vendido)
                {
                    <span class="badge bg-danger position-absolute top-0 start-0 m-2">Vendida!</span>
                }
                else if (ViewBag.TipoAnuncio == "pecas" && anuncio.IdPecaNavigation?.Stock <= 10)
                {
                    <span class="badge bg-danger position-absolute top-0 start-0 m-2">A esgotar!</span>
                }
                else if (ViewBag.TipoAnuncio == "motos" && diasPublicacao <= 30)
                {
                    <span class="badge bg-success position-absolute top-0 start-0 m-2">Novo!</span>
                }

                <div class="card-body card-body-fixed-height">
                    <p class="card-text">@anuncio.Titulo</p>
                    <p class="text-muted">Preço: €@anuncio.Preco.ToString("F2")</p>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <a asp-controller="DetalhesAnuncios" asp-action="DetalheAnuncio"
                               asp-route-id="@(ViewBag.TipoAnuncio == "motos" ? anuncio.IdAnuncioMoto : anuncio.IdAnuncioPeca)"
                               asp-route-tipo="@ViewBag.TipoAnuncio"
                               class="btn btn-sm btn-outline-secondary">
                                Ver
                            </a>
                        </div>
                        <small class="text-body-secondary">
                            Publicado: @(anuncio.DataPublicacao?.ToString("dd/MM/yyyy") ?? "Data não disponível")
                        </small>
                    </div>

                </div>
            </div>
        </div>
    }
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#marcaDropdown').change(function () {
            var marcaSelecionada = $(this).val();
            if (marcaSelecionada) {
                $('#modeloDropdown').prop('disabled', false);
                // Carregar modelos com base na marca selecionada
                // Exemplo: $('#modeloDropdown').html('<option value="Modelo1">Modelo1</option><option value="Modelo2">Modelo2</option>');
            } else {
                $('#modeloDropdown').prop('disabled', true).val('');
            }
        });
    });

    function filterAnuncios() {
        var marca = $('#marcaDropdown').val();
        var modelo = $('#modeloDropdown').val();
        var preco = $('#precoDropdown').val();
        var genero = $('#generoDropdown').val();
        var cor = $('#corDropdown').val();

        $('.anuncio-card').each(function () {
            var card = $(this);
            var cardMarca = card.data('marca');
            var cardModelo = card.data('modelo');
            var cardPreco = card.data('preco');
            var cardGenero = card.data('genero');
            var cardCor = card.data('cor');

            var showCard = true;

            if (marca && cardMarca !== marca) {
                showCard = false;
            }
            if (modelo && cardModelo !== modelo) {
                showCard = false;
            }
            if (preco) {
                var precoRange = preco.split('-');
                var precoMin = parseFloat(precoRange[0]);
                var precoMax = precoRange[1] ? parseFloat(precoRange[1]) : Infinity;
                if (cardPreco < precoMin || cardPreco > precoMax) {
                    showCard = false;
                }
            }
            if (genero && cardGenero !== genero) {
                showCard = false;
            }
            if (cor && cardCor !== cor) {
                showCard = false;
            }

            if (showCard) {
                card.show();
            } else {
                card.hide();
            }
        });
    }

    function sortAnuncios() {
        var sortBy = $('#ordenarPorDropdown').val();
        var anunciosContainer = $('#anunciosContainer');
        var anuncios = $('.anuncio-card').get();

        anuncios.sort(function (a, b) {
            var aData = $(a).data();
            var bData = $(b).data();

            if (sortBy === 'precoAsc') {
                return aData.preco - bData.preco;
            } else if (sortBy === 'precoDesc') {
                return bData.preco - aData.preco;
            } else if (sortBy === 'data') {
                return new Date(bData.dataPublicacao) - new Date(aData.dataPublicacao);
            } else {
                return 0;
            }
        });

        $.each(anuncios, function (index, anuncio) {
            anunciosContainer.append(anuncio);
        });
    }
</script>