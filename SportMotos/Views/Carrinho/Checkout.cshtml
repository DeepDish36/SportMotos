@model SportMotos.Models.EnderecosEnvio

@{
    ViewData["Title"] = "Finalizar Compra";
}

<h2>Finalizar Compra</h2>

<form method="post" asp-action="ProcessarCheckout">
    <div class="row">
        <!-- 🔥 Formulário de envio -->
        <div class="col-md-6">
            <h3>Informações de Envio</h3>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" required>
            </div>

            <!-- Nome e Apelido lado a lado -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nome</label>
                    <input type="text" asp-for="Nome" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Apelido</label>
                    <input type="text" asp-for="Apelido" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Telefone</label>
                <input type="text" asp-for="Telefone" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Localidade</label>
                <input type="text" asp-for="Localidade" class="form-control" required>
            </div>

            <!-- Cidade e Código Postal lado a lado -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Cidade</label>
                    <input type="text" asp-for="Cidade" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Código Postal</label>
                    <input type="text" asp-for="CodigoPostal" class="form-control" required>
                </div>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" asp-for="RetiradaNaLoja" class="form-check-input">
                <label class="form-check-label">Levantar na loja</label>
            </div>

            <div class="mb-3">
                <h3>Método de pagamento</h3>
                <select id="paymentMethod" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="visa">Visa/Mastercard</option>
                    <option value="paypal">PayPal</option>
                    <option value="mbway">MB WAY</option>
                </select>
            </div>

            <!-- 🔥 Campos dinâmicos para os detalhes do pagamento -->
            <div id="paymentDetails" style="display: none;">
                <div id="visaFields" style="display: none;">
                    <label class="form-label">Número do Cartão</label>
                    <input type="text" class="form-control" placeholder="XXXX XXXX XXXX XXXX">
                    <label class="form-label">
                        CVV
                        <span data-bs-toggle="tooltip" title="Os 3 dígitos atrás do cartão">❓</span>
                    </label>
                    <input type="text" class="form-control" placeholder="XXX">
                    <label class="form-label">Válido até</label>
                    <input type="text" id="validUntil" class="form-control" placeholder="MM/AA" required>

                    <script>
                        document.getElementById("validUntil").addEventListener("input", function () {
                            this.value = this.value.replace(/[^0-9/]/g, ""); // 🔥 Permite apenas números e "/"

                            if (this.value.length === 2 && !this.value.includes("/")) {
                                this.value += "/"; // 🔥 Adiciona "/" automaticamente após o mês
                            }

                            if (this.value.length > 5) {
                                this.value = this.value.slice(0, 5); // 🔥 Limita o campo a "MM/AA"
                            }
                        });
                    </script>
                </div>

                <div id="paypalFields" style="display: none;">
                    <label class="form-label">Email do PayPal</label>
                    <input type="email" class="form-control" placeholder="seuemail@email.com">
                </div>

                <div id="mbwayFields" style="display: none;">
                    <label class="form-label">Número de Telefone MB WAY</label>
                    <input type="text" class="form-control" placeholder="XXXXXXXXX">
                </div>
            </div>
        </div>

        <!-- 🔥 Resumo do Carrinho -->
        <div class="col-md-6">
            <h3>Resumo do Carrinho</h3>
            <ul class="list-group">
                @foreach (var item in ViewBag.Carrinho)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="@Url.Content("~/images/pecas/" + item.IdPeca + ".jpg")" class="rounded me-3" style="width: 80px; height: 80px;">
                            <div>
                                <h5>@item.Peca.Nome @item.Peca.Marca @item.Peca.Modelo</h5>
                                <p class="text-muted">Qtd.: @item.Quantidade</p>
                                <p class="text-muted">Preço: €@item.Peca.Preco.ToString("0.00")</p>
                            </div>
                        </div>
                    </li>
                }
            </ul>

            <hr>
            <h4>
                Total: <strong>€<span id="totalPrice">@ViewBag.TotalCompra.ToString("0.00")</span></strong>
                <span id="extraFee" style="display: inline;">+ €5</span>
            </h4>

            <!-- 🔥 Botão de checkout -->
            <button type="submit" class="btn btn-success w-100 mt-3">Fazer Checkout</button>

            <p class="mt-3 text-muted">Garantia de devolução em 30 dias.</p>
        </div>
    </div>
</form>
<script>
            document.addEventListener("DOMContentLoaded", function () {
        const paymentMethod = document.querySelector("#paymentMethod");
        const paymentDetails = document.querySelector("#paymentDetails");
        const visaFields = document.querySelector("#visaFields");
        const paypalFields = document.querySelector("#paypalFields");
        const mbwayFields = document.querySelector("#mbwayFields");

        const pickupCheckbox = document.querySelector("#pickupCheckbox");
        const extraFee = document.querySelector("#extraFee");

        // Verifica se os elementos existem antes de adicionar o evento
        if (pickupCheckbox && extraFee) {
            pickupCheckbox.addEventListener("change", function () {
                if (this.checked) {
                    extraFee.style.display = "none"; // Esconde o "+ €5"
                } else {
                    extraFee.style.display = "inline"; // Mostra o "+ €5"
                }
            });
        }

        // 🔥 Verifica se os elementos existem antes de adicionar evento
        if (paymentMethod && paymentDetails) {
            paymentMethod.addEventListener("change", function () {
                const selectedPayment = this.value;

                // 🔥 Oculta todos os campos primeiro
                paymentDetails.style.display = "none";
                visaFields.style.display = "none";
                paypalFields.style.display = "none";
                mbwayFields.style.display = "none";

                // 🔥 Se um método foi selecionado, exibe os campos correspondentes
                if (selectedPayment) {
                    paymentDetails.style.display = "block";
                    document.querySelector(`#${selectedPayment}Fields`).style.display = "block";
                }
            });
        }
    });
</script>